# WildNest 酒吧推荐服务实现方案

## 一、功能概述

### 1.1 业务目标
- 通过问答式交互，为用户推荐最适合的酒品
- 基于用户的心情、场合、口味偏好等因素进行智能匹配
- 提供个性化的酒品推荐体验，提升用户满意度

### 1.2 核心特性
- **问答式推荐流程**：3-5步选择题，逐步收集用户偏好
- **智能匹配算法**：基于规则引擎的推荐逻辑
- **个性化结果**：提供推荐理由和酒品详情
- **数据驱动优化**：记录推荐日志，持续优化算法

## 二、系统架构设计

### 2.1 整体架构
```
前端交互层
├─ 问答流程组件（Vue3 + Vant UI）
├─ 进度展示组件
├─ 结果展示组件
└─ 推荐理由说明

业务逻辑层
├─ 推荐控制器（RecommendController）
├─ 推荐服务（RecommendService）
├─ 规则引擎（RecommendationEngine）
└─ 算法计算（ScoreCalculator）

数据访问层
├─ 问题管理（QuestionMapper）
├─ 选项管理（OptionMapper）
├─ 规则管理（RecommendationRuleMapper）
└─ 日志记录（RecommendationLogMapper）

数据存储层
├─ 问题库（question表）
├─ 选项库（option表）
├─ 推荐规则（recommendation_rule表）
└─ 推荐日志（recommendation_log表）
```

### 2.2 数据模型设计

#### 问题表（question）
```sql
CREATE TABLE question (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL COMMENT '问题标题',
    description TEXT COMMENT '问题描述',
    question_type ENUM('single', 'multiple') DEFAULT 'single' COMMENT '问题类型：单选/多选',
    sort_order INT DEFAULT 0 COMMENT '排序值',
    is_active BIT DEFAULT 1 COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 选项表（option）
```sql
CREATE TABLE option (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    question_id BIGINT NOT NULL COMMENT '问题ID',
    content VARCHAR(200) NOT NULL COMMENT '选项内容',
    weight_value DECIMAL(3,2) DEFAULT 1.00 COMMENT '权重值',
    tag_keywords VARCHAR(500) COMMENT '关联标签（逗号分隔）',
    sort_order INT DEFAULT 0 COMMENT '排序值',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (question_id) REFERENCES question(id)
);
```

#### 推荐规则表（recommendation_rule）
```sql
CREATE TABLE recommendation_rule (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    rule_name VARCHAR(100) NOT NULL COMMENT '规则名称',
    option_combination TEXT NOT NULL COMMENT '选项组合（JSON格式）',
    target_drink_ids TEXT NOT NULL COMMENT '目标酒品ID列表（逗号分隔）',
    match_score DECIMAL(5,2) DEFAULT 0.00 COMMENT '匹配分数',
    recommendation_reason VARCHAR(500) COMMENT '推荐理由',
    is_active BIT DEFAULT 1 COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 推荐日志表（recommendation_log）
```sql
CREATE TABLE recommendation_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    session_id VARCHAR(64) COMMENT '会话ID',
    user_answers TEXT NOT NULL COMMENT '用户答案（JSON格式）',
    recommended_drinks TEXT COMMENT '推荐结果（JSON格式）',
    algorithm_version VARCHAR(20) DEFAULT 'v1.0' COMMENT '算法版本',
    user_ip VARCHAR(45) COMMENT '用户IP',
    user_agent TEXT COMMENT '用户代理',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 三、推荐算法设计

### 3.1 算法流程
```
用户开始推荐 → 获取问题列表 → 逐步回答问题 → 收集用户选择 → 计算匹配分数 → 生成推荐结果 → 返回推荐酒品
```

### 3.2 核心算法逻辑

#### 基于规则的匹配算法
```
1. 权重计算：
   - 每个选项都有权重值（0.1-2.0）
   - 用户选择的选项权重累加
   - 不同问题的权重可以不同

2. 标签匹配：
   - 选项包含标签关键词
   - 酒品也有标签属性
   - 计算标签重叠度

3. 规则匹配：
   - 预定义推荐规则
   - 匹配用户选择组合
   - 返回对应的酒品列表

4. 分数计算：
   总分 = Σ(选项权重 × 标签匹配度 × 规则匹配度)
```

#### 推荐策略
```
1. 精确匹配：
   - 完全匹配预定义规则
   - 返回规则对应的酒品

2. 模糊匹配：
   - 部分匹配多个规则
   - 按匹配度排序
   - 取前N个酒品

3. 兜底策略：
   - 无匹配规则时
   - 返回热门推荐酒品
   - 或基于标签的相似酒品
```

### 3.3 示例推荐规则

#### 场景1：放松解压
```json
{
  "rule_name": "放松解压推荐",
  "conditions": {
    "mood": ["放松", "解压"],
    "occasion": ["独自一人", "朋友小聚"],
    "taste_preference": ["清爽", "果味"]
  },
  "recommended_drinks": ["莫吉托", "蓝色夏威夷", "柠檬汽水"],
  "reason": "清爽的果味鸡尾酒能够帮助您放松心情，缓解一天的疲劳"
}
```

#### 场景2：庆祝生日
```json
{
  "rule_name": "生日庆祝推荐",
  "conditions": {
    "occasion": ["生日", "庆祝"],
    "atmosphere": ["热闹", "欢乐"],
    "alcohol_preference": ["中等", "较高"]
  },
  "recommended_drinks": ["香槟", "龙舌兰日出", "长岛冰茶"],
  "reason": "庆祝时刻需要有仪式感的酒品，香槟和特色鸡尾酒是完美选择"
}
```

## 四、接口设计

### 4.1 RESTful API 设计

#### 获取推荐问题
```
GET /api/recommend/questions

响应示例：
{
  "code": 200,
  "message": "获取成功",
  "data": [
    {
      "id": 1,
      "title": "您现在的心情如何？",
      "description": "选择最符合您当前状态的选项",
      "type": "single",
      "options": [
        {"id": 1, "content": "放松休闲", "weight": 1.0},
        {"id": 2, "content": "兴奋激动", "weight": 1.2},
        {"id": 3, "content": "需要解压", "weight": 0.8}
      ]
    }
  ]
}
```

#### 提交推荐请求
```
POST /api/recommend/result

请求体：
{
  "answers": [
    {"questionId": 1, "optionIds": [1]},
    {"questionId": 2, "optionIds": [3, 4]},
    {"questionId": 3, "optionIds": [2]}
  ],
  "sessionId": "uuid-string"
}

响应示例：
{
  "code": 200,
  "message": "推荐成功",
  "data": {
    "recommendations": [
      {
        "drink": {
          "id": 15,
          "name": "莫吉托",
          "englishName": "Mojito",
          "price": 68.00,
          "alcoholContent": 12.5,
          "description": "清爽的薄荷朗姆酒鸡尾酒",
          "imageUrl": "/images/mojito.jpg"
        },
        "matchScore": 95.5,
        "reason": "基于您的心情和偏好，莫吉托的清爽薄荷味能够帮助您放松心情"
      }
    ],
    "totalCount": 3,
    "algorithmVersion": "v1.0"
  }
}
```

### 4.2 管理员接口

#### 问题管理
```
GET /api/admin/recommend/questions     # 获取问题列表
POST /api/admin/recommend/questions    # 创建问题
PUT /api/admin/recommend/questions/:id # 更新问题
DELETE /api/admin/recommend/questions/:id # 删除问题
```

#### 规则管理
```
GET /api/admin/recommend/rules         # 获取规则列表
POST /api/admin/recommend/rules        # 创建规则
PUT /api/admin/recommend/rules/:id     # 更新规则
DELETE /api/admin/recommend/rules/:id  # 删除规则
```

#### 数据统计
```
GET /api/admin/recommend/statistics    # 推荐统计数据
GET /api/admin/recommend/logs          # 推荐日志查询
```

## 五、前端交互设计

### 5.1 用户流程
```
1. 进入推荐页面
   ↓
2. 显示欢迎界面和说明
   ↓
3. 开始问答流程
   ├─ 显示当前问题
   ├─ 展示选项列表
   ├─ 用户选择答案
   └─ 显示进度条
   ↓
4. 完成所有问题
   ↓
5. 计算推荐结果
   ↓
6. 展示推荐酒品
   ├─ 酒品图片和信息
   ├─ 推荐理由说明
   ├─ 匹配度显示
   └─ 查看详情按钮
   ↓
7. 用户可以重新推荐或查看酒品详情
```

### 5.2 界面组件

#### 问题组件
```vue
<template>
  <div class="question-card">
    <h2 class="question-title">{{ question.title }}</h2>
    <p class="question-desc">{{ question.description }}</p>
    
    <div class="options">
      <div 
        v-for="option in question.options" 
        :key="option.id"
        class="option-item"
        :class="{ active: isSelected(option.id) }"
        @click="selectOption(option.id)"
      >
        {{ option.content }}
      </div>
    </div>
  </div>
</template>
```

#### 进度组件
```vue
<template>
  <div class="progress-section">
    <van-progress 
      :percentage="progressPercentage" 
      color="#667eea"
    />
    <p class="progress-text">
      第 {{ currentStep }} / {{ totalSteps }} 步
    </p>
  </div>
</template>
```

#### 结果组件
```vue
<template>
  <div class="result-section">
    <h2 class="result-title">为您推荐</h2>
    
    <div 
      v-for="item in recommendations" 
      :key="item.drink.id"
      class="recommendation-card"
    >
      <div class="drink-image">
        <van-image :src="item.drink.imageUrl" />
      </div>
      
      <div class="drink-info">
        <h3>{{ item.drink.name }}</h3>
        <p class="reason">{{ item.reason }}</p>
        <div class="match-score">
          匹配度：{{ item.matchScore }}%
        </div>
      </div>
    </div>
  </div>
</template>
```

## 六、性能优化策略

### 6.1 缓存策略
```
1. 问题列表缓存：
   - Redis缓存问题和选项数据
   - 缓存时间：24小时
   - 管理员更新时清除缓存

2. 推荐规则缓存：
   - 内存缓存规则匹配逻辑
   - 启动时加载，定时刷新
   - 支持热更新

3. 推荐结果缓存：
   - 相同答案组合缓存结果
   - 缓存时间：1小时
   - 减少重复计算
```

### 6.2 算法优化
```
1. 预计算优化：
   - 预计算常见组合的推荐结果
   - 建立选项-酒品映射索引
   - 减少实时计算量

2. 分层匹配：
   - 先进行粗粒度匹配
   - 再进行细粒度计算
   - 提高匹配效率

3. 并行计算：
   - 多个规则并行匹配
   - 异步计算推荐分数
   - 提升响应速度
```

## 七、数据分析与优化

### 7.1 数据收集
```
1. 用户行为数据：
   - 问题回答选择
   - 推荐结果点击
   - 最终酒品选择
   - 用户满意度反馈

2. 推荐效果数据：
   - 推荐准确率
   - 用户接受率
   - 转化率统计
   - 算法性能指标
```

### 7.2 持续优化
```
1. A/B测试：
   - 不同算法版本对比
   - 问题设计优化
   - 推荐策略调整

2. 机器学习增强：
   - 基于历史数据训练模型
   - 个性化推荐权重
   - 动态调整推荐规则

3. 用户反馈循环：
   - 收集用户评价
   - 优化推荐理由
   - 调整匹配算法
```

## 八、实施计划

### 8.1 开发阶段（第1-2周）
```
1. 数据库设计和创建
2. 后端实体类和Mapper开发
3. 推荐服务核心逻辑实现
4. 基础推荐算法开发
5. RESTful API接口实现
```

### 8.2 测试阶段（第3周）
```
1. 单元测试编写
2. 集成测试验证
3. 推荐算法调优
4. 性能测试和优化
5. 前后端联调测试
```

### 8.3 上线阶段（第4周）
```
1. 生产环境部署
2. 基础数据导入
3. 推荐规则配置
4. 用户体验测试
5. 监控和日志配置
```

## 九、风险控制

### 9.1 技术风险
```
1. 算法复杂度控制
   - 避免过度复杂的匹配逻辑
   - 保证响应时间在可接受范围
   - 提供降级策略

2. 数据一致性
   - 确保推荐规则的逻辑一致性
   - 避免循环依赖和冲突规则
   - 建立数据校验机制
```

### 9.2 业务风险
```
1. 推荐准确性
   - 建立推荐效果评估机制
   - 提供用户反馈渠道
   - 持续优化推荐质量

2. 用户体验
   - 简化问答流程
   - 提供清晰的推荐理由
   - 支持重新推荐功能
```

## 十、总结

推荐服务是WildNest酒吧H5项目的核心功能之一，通过问答式交互和智能算法，为用户提供个性化的酒品推荐体验。本方案采用基于规则的推荐算法，结合权重计算和标签匹配，能够有效满足不同用户的需求。

关键成功因素：
1. **简洁的用户交互**：3-5步问答，不增加用户负担
2. **智能的匹配算法**：基于多维度因素的综合推荐
3. **灵活的规则配置**：支持管理员动态调整推荐策略
4. **持续的优化机制**：基于数据分析不断改进推荐效果

通过这套推荐服务，能够显著提升用户体验，增加用户粘性，为酒吧带来更多的商业价值。